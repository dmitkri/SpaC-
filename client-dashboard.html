<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Личный кабинет - СПА Салон</title>
    <link rel="stylesheet" href="style.css">
    <script src="mock-api.js"></script>
    <script src="sync-jsonbin.js"></script>
    <style>
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 48px;
        }
        
        .dashboard-header {
            margin-bottom: 40px;
        }
        
        .dashboard-header h1 {
            font-size: 32px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 8px;
        }
        
        .dashboard-header p {
            color: #666666;
            font-size: 16px;
        }
        
        .dashboard-tabs {
            display: flex;
            gap: 0;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 32px;
        }
        
        .dashboard-tab {
            padding: 16px 24px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            color: #666666;
            transition: all 0.3s ease;
            position: relative;
            bottom: -1px;
        }
        
        .dashboard-tab:hover {
            color: #1a1a1a;
        }
        
        .dashboard-tab.active {
            color: #1a1a1a;
            border-bottom-color: #1a1a1a;
        }
        
        .dashboard-content {
            display: none;
        }
        
        .dashboard-content.active {
            display: block;
        }
        
        .booking-card {
            background: #f8f8f8;
            border: 1px solid #e0e0e0;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }
        
        .booking-card:hover {
            border-color: #d0d0d0;
            background: #ffffff;
        }
        
        .booking-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 16px;
        }
        
        .booking-card h3 {
            font-size: 20px;
            font-weight: 600;
            color: #1a1a1a;
            margin: 0;
        }
        
        .booking-info {
            color: #666666;
            font-size: 14px;
            margin: 8px 0;
        }
        
        .booking-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }
        
        .btn-small {
            padding: 8px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #ffffff;
            color: #1a1a1a;
        }
        
        .btn-small:hover {
            background: #f8f8f8;
            border-color: #d0d0d0;
        }
        
        .btn-small.danger {
            color: #c62828;
            border-color: #ef9a9a;
            background: #ffebee;
        }
        
        .btn-small.success {
            color: #2e7d32;
            border-color: #a5d6a7;
            background: #e8f5e9;
        }
        
        .review-form {
            background: #f8f8f8;
            border: 1px solid #e0e0e0;
            border-radius: 16px;
            padding: 24px;
            margin-top: 16px;
            display: none;
        }
        
        .review-form.active {
            display: block;
        }
        
        .review-form textarea {
            width: 100%;
            padding: 14px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background: #ffffff;
            color: #1a1a1a;
            font-family: inherit;
            font-size: 14px;
            min-height: 100px;
            margin-bottom: 16px;
        }
        
        .review-form input[type="number"] {
            width: 100px;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #ffffff;
            color: #1a1a1a;
            font-size: 16px;
            margin-bottom: 16px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }
        
        .stat-card {
            background: #f8f8f8;
            border: 1px solid #e0e0e0;
            border-radius: 16px;
            padding: 24px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 8px;
        }
        
        .stat-label {
            color: #666666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Личный кабинет</h1>
            <div class="booking-link">
                <a href="home.html">Главная</a>
                <a href="client.html" style="margin-left: 12px;">Записаться</a>
                <a href="#" onclick="logout()" style="margin-left: 12px;">Выйти</a>
            </div>
        </div>
        
        <div class="dashboard-container">
            <div class="dashboard-header">
                <h1 id="welcome-name">Добро пожаловать!</h1>
                <p id="client-info">Загружаем данные...</p>
            </div>
            
            <div class="dashboard-tabs">
                <button class="dashboard-tab active" onclick="showDashboardTab('bookings')">Мои записи</button>
                <button class="dashboard-tab" onclick="showDashboardTab('new-booking')">Новая запись</button>
                <button class="dashboard-tab" onclick="showDashboardTab('reviews')">Отзывы</button>
            </div>
            
            <!-- Мои записи -->
            <div id="dashboard-bookings-tab" class="dashboard-content active">
                <h2>Мои записи</h2>
                <div id="dashboard-bookings-list"></div>
            </div>
            
            <!-- Новая запись -->
            <div id="new-booking-tab" class="dashboard-content">
                <h2>Новая запись</h2>
                <p style="color: #666666; margin-bottom: 24px;">Выберите услугу, мастера и удобное время</p>
                <a href="client.html" class="btn-hero btn-hero-primary" style="display: inline-block; text-decoration: none;">Перейти к записи</a>
            </div>
            
            <!-- Отзывы -->
            <div id="reviews-tab" class="dashboard-content">
                <h2>Мои отзывы</h2>
                <p style="color: #666666; margin-bottom: 24px;">Записи, на которые вы оставили отзывы</p>
                <div id="reviews-list"></div>
            </div>
        </div>
    </div>
    
    <script>
        const API_URL = ''; // Используется mock API для GitHub Pages
        let currentClientId = null;
        let currentClientRole = null;
        
        window.onload = function() {
            // Проверяем авторизацию
            currentClientId = localStorage.getItem('clientId');
            currentClientRole = localStorage.getItem('clientRole');
            
            if (!currentClientId) {
                window.location.href = 'login.html';
                return;
            }
            
            loadClientInfo();
            loadBookings();
        };
        
        function showDashboardTab(tab) {
            document.querySelectorAll('.dashboard-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.dashboard-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + '-tab').classList.add('active');
            
            if (tab === 'bookings') {
                loadBookings();
            } else if (tab === 'reviews') {
                loadReviews();
            }
        }
        
        async function loadClientInfo() {
            try {
                const response = await fetch(`${API_URL}/api/clients/${currentClientId}`);
                const client = await response.json();
                
                if (client.id) {
                    document.getElementById('welcome-name').textContent = `Добро пожаловать, ${client.firstName} ${client.lastName}!`;
                    document.getElementById('client-info').textContent = `Email: ${client.email} | Телефон: ${client.phone} | Бонусы: ${client.bonusPoints || 0}`;
                }
            } catch (error) {
                console.error('Ошибка загрузки данных клиента:', error);
            }
        }
        
        async function loadBookings() {
            const listEl = document.getElementById('dashboard-bookings-list');
            listEl.innerHTML = '<p style="color: #666666;">Загрузка...</p>';
            
            try {
                const response = await fetch(`${API_URL}/api/clients/${currentClientId}/bookings`);
                const bookings = await response.json();
                
                if (!Array.isArray(bookings)) {
                    listEl.innerHTML = '<p style="color: #666666;">Нет записей</p>';
                    return;
                }
                
                if (bookings.length === 0) {
                    listEl.innerHTML = '<p style="color: #666666;">У вас пока нет записей</p>';
                    return;
                }
                
                // Загружаем отзывы клиента, чтобы проверить, какие записи уже имеют отзывы
                const reviewsResponse = await fetch(`${API_URL}/api/reviews?clientId=${currentClientId}`);
                const reviews = await reviewsResponse.json();
                const reviewsByBooking = {};
                if (Array.isArray(reviews)) {
                    reviews.forEach(review => {
                        if (review.bookingId > 0) {
                            reviewsByBooking[review.bookingId] = review;
                        }
                    });
                }
                
                listEl.innerHTML = '';
                
                // Загружаем услуги и мастеров для отображения
                const servicesResponse = await fetch(`${API_URL}/api/services`);
                const services = await servicesResponse.json();
                const specialistsResponse = await fetch(`${API_URL}/api/specialists`);
                const specialists = await specialistsResponse.json();
                
                bookings.forEach(booking => {
                    const service = services.find(s => s.id === booking.serviceId);
                    const specialist = specialists.find(s => s.id === booking.specialistId);
                    
                    const card = document.createElement('div');
                    card.className = 'booking-card';
                    
                    const statusClass = booking.status === 'выполнена' ? 'success' : 
                                      booking.status === 'отменена' ? 'danger' : '';
                    
                    // Проверяем, есть ли уже отзыв на эту запись
                    const hasReview = reviewsByBooking[booking.id];
                    
                    card.innerHTML = `
                        <div class="booking-card-header">
                            <div>
                                <h3>${service ? service.name : 'Услуга #' + booking.serviceId}</h3>
                                <div class="booking-info">Мастер: ${specialist ? specialist.name : 'Не указан'}</div>
                                <div class="booking-info">Дата: ${booking.date}</div>
                                <div class="booking-info">Время: ${booking.time} - ${booking.endTime}</div>
                                <div class="booking-info">Статус: <span class="status ${statusClass}">${booking.status}</span></div>
                                ${booking.notes ? `<div class="booking-info">Комментарий: ${booking.notes}</div>` : ''}
                                ${hasReview ? `<div class="booking-info" style="margin-top: 12px; color: #2e7d32; font-weight: 600;">✓ Отзыв оставлен</div>` : ''}
                            </div>
                        </div>
                        <div class="booking-actions">
                            ${booking.status === 'запланирована' ? 
                                `<button class="btn-small danger" onclick="cancelBooking(${booking.id})">Отменить</button>` : ''}
                            ${booking.status === 'выполнена' && !hasReview ? 
                                `<button class="btn-small success" onclick="showReviewForm(${booking.id})">Оставить отзыв</button>` : ''}
                        </div>
                        <div class="review-form" id="review-form-${booking.id}">
                            <h4 style="color: #1a1a1a; margin-bottom: 16px;">Оставить отзыв</h4>
                            <label style="color: #1a1a1a; display: block; margin-bottom: 8px;">Оценка (1-5):</label>
                            <input type="number" id="rating-${booking.id}" min="1" max="5" value="5">
                            <label style="color: #1a1a1a; display: block; margin-bottom: 8px; margin-top: 16px;">Комментарий:</label>
                            <textarea id="review-text-${booking.id}" placeholder="Ваш отзыв..."></textarea>
                            <button class="btn-small success" onclick="submitReview(${booking.id}, ${booking.specialistId})">Отправить</button>
                            <button class="btn-small" onclick="hideReviewForm(${booking.id})" style="margin-left: 8px;">Отмена</button>
                        </div>
                    `;
                    
                    listEl.appendChild(card);
                });
            } catch (error) {
                console.error('Ошибка загрузки записей:', error);
                listEl.innerHTML = '<p style="color: #c62828;">Ошибка загрузки записей</p>';
            }
        }
        
        async function cancelBooking(bookingId) {
            if (!confirm('Вы уверены, что хотите отменить запись?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/bookings/${bookingId}/cancel`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                if (data.success) {
                    loadBookings();
                } else {
                    alert(data.error || 'Ошибка отмены записи');
                }
            } catch (error) {
                alert('Ошибка соединения с сервером');
            }
        }
        
        function showReviewForm(bookingId) {
            document.getElementById(`review-form-${bookingId}`).classList.add('active');
        }
        
        function hideReviewForm(bookingId) {
            document.getElementById(`review-form-${bookingId}`).classList.remove('active');
        }
        
        async function submitReview(bookingId, specialistId) {
            const rating = document.getElementById(`rating-${bookingId}`).value;
            const text = document.getElementById(`review-text-${bookingId}`).value;
            
            if (!rating || rating < 1 || rating > 5) {
                alert('Пожалуйста, выберите оценку от 1 до 5');
                return;
            }
            
            try {
                // Отправляем отзыв на сервер
                const response = await fetch(`${API_URL}/api/specialists/${specialistId}/review`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        clientId: parseInt(currentClientId),
                        rating: parseInt(rating),
                        text: text,
                        bookingId: bookingId
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('Отзыв отправлен! Спасибо за ваше мнение.');
                    hideReviewForm(bookingId);
                    loadBookings();
                    // Если открыта вкладка отзывов, обновляем её
                    if (document.getElementById('reviews-tab').classList.contains('active')) {
                        loadReviews();
                    }
                } else {
                    alert(data.error || 'Ошибка отправки отзыва');
                }
            } catch (error) {
                alert('Ошибка отправки отзыва');
            }
        }
        
        async function loadReviews() {
            const listEl = document.getElementById('reviews-list');
            listEl.innerHTML = '<p style="color: #666666;">Загрузка...</p>';
            
            try {
                // Загружаем отзывы клиента
                const reviewsResponse = await fetch(`${API_URL}/api/reviews?clientId=${currentClientId}`);
                const reviews = await reviewsResponse.json();
                
                if (!Array.isArray(reviews) || reviews.length === 0) {
                    listEl.innerHTML = '<p style="color: #666666;">У вас пока нет отзывов. Оставьте отзыв после завершения записи!</p>';
                    return;
                }
                
                // Загружаем услуги и мастеров для отображения
                const servicesResponse = await fetch(`${API_URL}/api/services`);
                const services = await servicesResponse.json();
                const specialistsResponse = await fetch(`${API_URL}/api/specialists`);
                const specialists = await specialistsResponse.json();
                
                // Загружаем все записи клиента, чтобы получить информацию о записях с отзывами
                const bookingsResponse = await fetch(`${API_URL}/api/clients/${currentClientId}/bookings`);
                const bookings = await bookingsResponse.json();
                
                listEl.innerHTML = '';
                
                // Группируем отзывы по bookingId
                const reviewsByBooking = {};
                reviews.forEach(review => {
                    if (review.bookingId > 0) {
                        reviewsByBooking[review.bookingId] = review;
                    }
                });
                
                // Отображаем записи с отзывами
                reviews.forEach(review => {
                    if (review.bookingId <= 0) return; // Пропускаем отзывы без привязки к записи
                    
                    const booking = Array.isArray(bookings) ? bookings.find(b => b.id === review.bookingId) : null;
                    if (!booking) return;
                    
                    const service = services.find(s => s.id === booking.serviceId);
                    const specialist = specialists.find(s => s.id === booking.specialistId);
                    
                    // Генерируем звезды для рейтинга
                    const stars = Array.from({length: 5}, (_, i) => 
                        i < review.rating ? '★' : '☆'
                    ).join('');
                    
                    const card = document.createElement('div');
                    card.className = 'booking-card';
                    
                    card.innerHTML = `
                        <div class="booking-card-header">
                            <div>
                                <h3>${service ? service.name : 'Услуга #' + booking.serviceId}</h3>
                                <div class="booking-info">Мастер: ${specialist ? specialist.name : 'Не указан'}</div>
                                <div class="booking-info">Дата: ${booking.date}</div>
                                <div class="booking-info">Время: ${booking.time} - ${booking.endTime}</div>
                                <div class="booking-info" style="margin-top: 16px;">
                                    <strong>Ваш отзыв:</strong>
                                </div>
                                <div class="booking-info" style="color: #ffc107; font-size: 18px; margin: 8px 0;">
                                    ${stars} (${review.rating}/5)
                                </div>
                                <div class="booking-info" style="font-style: italic; color: #666666; margin-top: 8px;">
                                    "${review.text || 'Без комментария'}"
                                </div>
                                <div class="booking-info" style="font-size: 12px; color: #999999; margin-top: 8px;">
                                    Дата отзыва: ${review.date}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    listEl.appendChild(card);
                });
                
            } catch (error) {
                console.error('Ошибка загрузки отзывов:', error);
                listEl.innerHTML = '<p style="color: #c62828;">Ошибка загрузки отзывов</p>';
            }
        }
        
        function logout() {
            localStorage.removeItem('clientId');
            localStorage.removeItem('clientRole');
            localStorage.removeItem('clientName');
            window.location.href = 'home.html';
        }
    </script>
</body>
</html>

